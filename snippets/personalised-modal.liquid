<div class="button custom-prebook">
  <div class="custom-prebook-heading">Personalize Them. It's Fast And Free</div>
  <div class="custom-prebook-subheading">
    Engrave A Mix Of Names,Intials, And Numbers To Make Airdopes Unmistakably Yours.
  </div>
</div>
<!-- Personalised Modal -->
<div class="personilaztion-message-modal-overlay"></div>
<div class="personilaztion-message-modal hide-popup">
  <div class="personilaztion-message-container">
    <div class="message-form-container">
      <div class="personalization-heading-wrapper">
        <span class="personalized-modal-close" id="close-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <path d="M23 20.168l-8.185-8.187 8.185-8.174-2.832-2.807-8.182 8.179-8.176-8.179-2.81 2.81 8.186 8.196-8.186 8.184 2.81 2.81 8.203-8.192 8.18 8.192z"/>
          </svg>
        </span>
        <span class="personalization-heading">PERSONALIZE YOUR AIRDOPES</span>
        <div class="personalization-sub-heading">Fast,Free Engraving Of Letters With A Click</div>
      </div>
      <div class="personalization-image-wrapper">
        <img src="{{ product.selected_or_first_available_variant.featured_image | image_url }}">
      </div>
      <input
        type="text"
        id="personalized-text"
        placeholder="YOUR ENGRAVING"
        maxlength="12"
        pattern="[a-zA-Z]+"
        autocomplete="new-password"
      >
      <div class="personalization-info">
        <p>Type names, initials or numbers, or mix'em up.</p>
        <p>Just don't exceed 12 character or use special symbols like emojis, $,@,!,#,etc.</p>
      </div>
      <button type="button" class="submit-personalization">SAVE</button>
      <button type="button" class="cancel-personalization personalized-modal-close">CANCEL</button>
    </div>
  </div>
</div>
<script>
    const customPrebookBtn = document.querySelector('.custom-prebook');
    const personalizationModalOverlay = document.querySelector('.personilaztion-message-modal-overlay');
    const personalizationModal = document.querySelector('.personilaztion-message-modal');
    const personalizationModalClose = document.querySelectorAll('.personalized-modal-close');
    const personalizationSubmitBtn = document.querySelector('.submit-personalization');
    const prebookBtn = document.querySelector('#AddToCart');
    const personalizedText = document.querySelector('#personalized-text');
    const personalizedMessageOriginal = document.querySelector('#personalised_message');
    const editMessage=document.querySelector(".edit-msg");
    let sessionValue=sessionStorage.getItem(personalizedMessageOriginal.getAttribute("variant-id"));
    let url=window.location.href;
    //Finding line item from URL params
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const line_item = urlParams.get('line-item');
    const pmsg = urlParams.get('msg');
    function openPersonalizationModal() {
        personalizationModalOverlay.classList.remove('hide')
        personalizationModal.classList.remove('hide-popup')
        document.body.classList.add('noScroll')
    }
    function closePersonalizationModal() {
        personalizationModalOverlay.classList.add('hide')
        personalizationModal.classList.add('hide-popup')
        document.body.classList.remove('noScroll')
    }
    function btnClick() {
        $('#AddToCart')[0].click();
      personalizedText.value="";
    }
    function cartRefresh() {
        document.documentElement.dispatchEvent(new CustomEvent("cart:refresh", {

            bubbles: !0
        })), document.getElementById("mini-cart").open = !0, $(".search-clear-icon").css('display', 'flex'), setTimeout(function() {
            $(".header__cart-count").html($("#mini-cart input.cart--count").val());
            $('.header__cart-count.header__cart-count--floating.bubble-count').text($("#mini-cart input.cart--count").val());
            cart_bubble();

        }, 1500)
    }
    (()=>{

      if(!url.includes("&personalized")){
        personalizationModal.classList.add("hide-popup");
        personalizationModalOverlay.classList.add("hide");
  personalizedText.value="";
      }else{
        if(pmsg){
        personalizedText.value=pmsg.toUpperCase();
        }
        personalizationModal.classList.remove("hide-popup");
        personalizationModalOverlay.classList.remove("hide");
      }
    })()
    function storePersonalizedMessage(){
    sessionValue=sessionStorage.setItem(personalizedMessageOriginal.getAttribute("variant-id"), personalizedText.value);
    personalizedText.value=sessionValue;
    }
    function updatePersonlizedMsg(){
       let formData = {
    'line': line_item,
    'properties': { 'Personalised Message': sessionStorage.getItem(personalizedMessageOriginal.getAttribute("variant-id")) }
    }
    ;

    fetch(window.Shopify.routes.root + 'cart/change.js', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify(formData)
    })
    .then(response => {
    return response.json();
    })
    .then(res=>{
    cartRefresh();
    })
    .catch((error) => {
    console.error('Error:', error);
    });

    }
    customPrebookBtn.addEventListener('click', openPersonalizationModal)
    personalizationModalOverlay.addEventListener('click', closePersonalizationModal)
    personalizationModalClose.forEach((closeBtn) =>{
      closeBtn.addEventListener('click', closePersonalizationModal)
    })

    personalizationSubmitBtn.addEventListener('click', (e) => {
        let pMessage = personalizedText.value;
        personalizedMessageOriginal.value = pMessage.toUpperCase()
        closePersonalizationModal()
        storePersonalizedMessage()
        if(!url.includes("&personalized")){
          btnClick()
        }else{
          updatePersonlizedMsg()
        }
        {% comment %} closePersonalizationModal() {% endcomment %}
    })
</script>
